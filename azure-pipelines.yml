trigger:
- main

variables:
  # Azure Service Principal credentials
- group: 'acr-sp-push'

  # Docker/ACR info
- name: ACR_NAME
  value: 'fstefanovacrlearning'
- name: IMAGE_NAME
  value: 'fstefanovvpythonsamplevscodeflasktutorial'
- name: TAG
  value: '$(Build.BuildId)'

stages:
- stage: BuildAndPush
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      name: 'Default'  # your self-hosted agent pool
    steps:

    # Install Docker if needed
    - task: DockerInstaller@0
      displayName: Install Docker
      inputs:
        dockerVersion: '20.10.24'

    # Login to Azure using Service Principal
    - task: AzureCLI@2
      displayName: 'Login to Azure using Service Principal'
      inputs:
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Logging in with service principal"
          az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
          az account set --subscription $AZURE_SUBSCRIPTION_ID

    # Login to ACR using the SP
    - script: |
        echo "Logging in to ACR"
        az acr login --name $(ACR_NAME)
      displayName: 'Login to ACR'

    # Build Docker image
    - script: |
        docker build -t $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(TAG) .
      displayName: 'Build Docker Image'

    # Push Docker image
    - script: |
        docker push $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(TAG)
      displayName: 'Push Docker Image'

